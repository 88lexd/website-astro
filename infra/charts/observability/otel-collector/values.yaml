---
opentelemetry-operator:
  enabled: true

# The default configuration for all collectors generated by the chart.
# Any collectors in the `collectors` are overlayed on top of this configuration.
defaultCRConfig:
  # Annotations for the collector's pods
  podAnnotations:
    prometheus.io/scrape: "true"

# Collectors is a map of collector configurations of the form:
# collectors:
#   collectorName:
#     enabled: true
#     name: "example"
# Each collector configuration is layered on top of the `defaultCRConfig`, overriding a default if set.
collectors:
  daemon:
    enabled: true
    suffix: daemon
    mode: daemonset
    resources:
      requests:
        cpu: 50m
        memory: 250Mi
      limits:
        cpu: "1"
        memory: 500Mi

    # Environment variables for the collector
    env: []
    # - name: ENV_VAR1
    #   value: value1
    # - name: ENV_VAR2
    #   value: value2

    # Tolerations for the collector to also run as Daemon on the master node
    tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

    # Observability configuration for the collector
    observability:
      metrics:
        enableMetrics: true

    # Target allocator configuration
    targetAllocator:
      enabled: true
      # image: myregistry/myimage:latest
      replicas: 1
      allocationStrategy: per-node
      resources:
        requests:
          cpu: "50m"
          memory: "64Mi"
        limits:
          cpu: "500m"
          memory: "128Mi"

    # A scrape config file (part of the kube-stack Chart itself) to instruct the daemon collector to pull metrics from any matching targets on the same node with
    # prometheus.io/scrape=true
    scrape_configs_file: "daemon_scrape_configs.yaml"
    presets:
      logsCollection:
        enabled: true
        includeCollectorLogs: false
      kubeletMetrics:
        enabled: false
      hostMetrics:
        enabled: true
      kubernetesAttributes:
        enabled: true
      kubernetesEvents:
        enabled: false
      clusterMetrics:
        enabled: false
    config:
      #################
      # Start Recivers
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318
      # End Recivers


      ###################
      # Start Processors
      processors:
        batch:
          send_batch_size: 1000
          timeout: 1s
          send_batch_max_size: 1500

        resourcedetection/env:
          detectors: [env]
          timeout: 2s
          override: false

        filter/exclude-logs:
          logs:
            # any logs matching filters are excluded from remainder of pipeline
            exclude:
              match_type: regexp
              resource_attributes:
                - key: k8s.namespace.name
                  value: metallb-system
      # End Processors


      ##################
      # Start Exporters
      exporters:
        debug: {}

        otlphttp/victoria-logs:
          # Note: Victoria Logs docs mentions the use of port `9428`, but this only applies to the `single` installation
          # I am running Victoria Logs Cluster, so the insert service uses port `9481` instead
          logs_endpoint: http://vlc-victoria-logs-cluster-vlinsert.monitoring.svc:9481/insert/opentelemetry/v1/logs
      # End Exporters

      ##########################
      # Start Service Pipelines
      service:
        pipelines:
          metrics:
            receivers:
              - otlp
            processors:
              - resourcedetection/env
              - batch
            exporters:
              - debug

          logs:
            receivers:
              # This receiver is created by the preset. Validate by running:
              # $ kubectl get opentelemetrycollectors -n monitoring otel-daemon -o yaml | yq '.spec.config.receivers.filelog'
              - filelog
            processors:
              # The k8sattributes processor is created by the preset. Validate by running:
              # $ kubectl get opentelemetrycollectors -n monitoring otel-daemon -o yaml | yq '.spec.config.processors.k8sattributes'
              - k8sattributes
              - filter/exclude-logs
              - resourcedetection/env
              - batch
            exporters:
              # - debug
              - otlphttp/victoria-logs
      # End Service Pipelines
